<!DOCTYPE html>
<html>
<head>
    <script src="http://code.createjs.com/easeljs-0.7.0.min.js"></script>
    <script>
		var KEYCODE_UP = 38;		//usefull keycode
		var KEYCODE_LEFT = 37;		//usefull keycode
		var KEYCODE_RIGHT = 39;		//usefull keycode
        var KEYCODE_DOWN = 40;

        var currentKeyH;
        var currentKeyV;
        var circle;
        var square;
	    var stage;
        var bgs;
        var canvas;
        var bgImg;

	    document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;

        function init() {

            canvas = document.getElementById("canvas");
            fullWindow(canvas);

            loadAssets();
        }

        function loadAssets()
        {
            bgImg = new Image();
            bgImg.onload = initDraw;
            bgImg.src = 'assets/background.jpg';
        }

        function initDraw()
        {            
            stage = new createjs.Stage("canvas");

            bgs = addBackgrounds(stage);
            circle = addCircle(200, 100, 50, stage);
            square = addSquare(200, 150, 50, stage);


            createjs.Ticker.addEventListener("tick", tick);
            createjs.Ticker.setFPS(40);

        }

        function fullWindow(canvas) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
         }


        function handleKeyDown(event){
            if(event.keyCode == KEYCODE_LEFT || event.keyCode == KEYCODE_RIGHT) {
                currentKeyH = event.keyCode;
            }
            else if(event.keyCode == KEYCODE_DOWN || event.keyCode == KEYCODE_UP) {
                currentKeyV= event.keyCode;
            }   
        }

        function handleKeyUp(event){
            if(currentKeyV == event.keyCode) {
                currentKeyV = null;
            }
            if(currentKeyH == event.keyCode) {            
                currentKeyH = null;
            }
        }

        function addBackgrounds(parent)
        {
            
            bgs = [];
            var numBG = Math.ceil(canvas.width/bgImg.width) +1;
            for (var i = 0; i < numBG; i++) {
                bgs.push(new createjs.Bitmap(bgImg));
                bgs[i].x = i*bgImg.width;
                bgs[i].y = canvas.height - bgImg.height;
                parent.addChildAt(bgs[i], i);
            };
            //bg.scaleX = 3;
            //bg.scaleY = 3;
            //bg.sourceRect = { x:0, y:0, width:canvas.width, height:canvas.height };

            return bgs;
        }

        function addCircle(x, y, radius, parent) {
        	var circle = new createjs.Shape();
			circle.graphics.beginFill("red").drawCircle(0, 0, radius);
			circle.x = x;
			circle.y = y;
			parent.addChild(circle);

			return circle;
        }
       
        function addSquare(x, y, length, parent) {
            var square = new createjs.Shape();
            square.graphics.beginFill("blue").drawRect(0, 0, length, length);
            square.x = x;
            square.y = y;
            parent.addChild(square);

            return square;
        }

        function tick(event) {
        	var delta = event.delta;

   			moveCircleH(delta);

            moveSquare(currentKeyH, currentKeyV, delta);

            moveBackground(currentKeyH, delta);
			// TODO
			// hittest on red square
            // move background in opposite direction
			// replace square with spritesheet animation

        	stage.update();
        }

        function moveCircleH(delta) {
        	if(circle.x - 50 < stage.canvas.width) {
	        	circle.x += delta/1000 * 20;
        	}
        	else {
        		circle.x = -50;
        	}
        }

        function moveSquare(x,y, delta) {
            if(currentKeyH == KEYCODE_RIGHT
                && square.x + 50 < stage.canvas.width) {
                square.x += delta/1000 * 100;
            }
            else if(currentKeyH == KEYCODE_LEFT
                && square.x > 0){
                square.x -= delta/1000 * 100;
            } 
            if(currentKeyV == KEYCODE_UP
                && square.y > 0) {
                square.y -= delta/1000 * 100;
            }
            else if(currentKeyV == KEYCODE_DOWN
                && square.y + 50 < stage.canvas.height){
                square.y += delta/1000 * 100;
            } 
        }

        function moveBackground(x, delta)
        {
            var decalX = 0;
            if(currentKeyH == KEYCODE_RIGHT) {
                decalX = -delta/400 * 100;
            }
            else if(currentKeyH == KEYCODE_LEFT){
                decalX = delta/400 * 100;
            }

            for (var i = bgs.length - 1; i >= 0; i--) {
                bgs[i].x += decalX;
                if (decalX < 0 && bgs[i].x < -bgImg.width) {
                    bgs[i].x += bgs.length * bgImg.width;
                }
                else if(decalX > 0 && bgs[i].x > canvas.width) {
                    bgs[i].x -= bgs.length * bgImg.width;
                }
            };
        }
    </script>
</head>
<body onLoad="init();">
    <canvas id="canvas" width="500" height="300" style="top: 0px; left: 0px; position: absolute;">
        Go get a new browser, you cheesy ;)
    </canvas>
</body>
</html>